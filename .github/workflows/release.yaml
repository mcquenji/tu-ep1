name: Release on push to main

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # we need tags

      - name: Determine next major tag
        id: version
        shell: bash
        run: |
          git fetch --tags --force

          # get latest tag like v1.0.0 (if any)
          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)
          echo "latest_tag=$latest_tag"

          if [ -z "$latest_tag" ]; then
            new_tag="v1.0.0"
            prev_tag=""
          else
            ver="${latest_tag#v}"      # strip leading v
            major="${ver%%.*}"         # major part
            new_major=$((major + 1))
            new_tag="v${new_major}.0.0"
            prev_tag="$latest_tag"
          fi

          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "prev_tag=$prev_tag" >> $GITHUB_OUTPUT

      - name: Generate release notes from conventional commits
        id: notes
        uses: actions/github-script@v7
        env:
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
          PREV_TAG: ${{ steps.version.outputs.prev_tag }}
        with:
          script: |
            const tag = process.env.NEW_TAG;
            const prev = process.env.PREV_TAG || undefined;

            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              target_commitish: context.sha,
            };
            if (prev) {
              params.previous_tag_name = prev;
            }

            const res = await github.rest.repos.generateReleaseNotes(params);
            core.setOutput('body', res.data.body);

      - name: Zip each top-level folder
        shell: bash
        run: |
          REPO="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"

          shopt -s nullglob
          for dir in */ ; do
            [ -d "$dir" ] || continue
            dir="${dir%/}"
            zip_name="${REPO}-${dir}-${OWNER}.zip"
            echo "Zipping $dir -> $zip_name"
            git archive -o "$zip_name" HEAD "$dir"
          done

          ls -lh *.zip || echo "No zip files created"

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.version.outputs.new_tag }}
          body: ${{ steps.notes.outputs.body }}
          files: "*.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
